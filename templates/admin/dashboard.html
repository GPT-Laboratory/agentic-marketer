{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Dashboard</h1>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

   

    <!-- Scheduler Testing -->
    <!-- <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Scheduler Testing</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <button class="btn btn-info" onclick="testScheduler()">
                        <i class="fas fa-play"></i> Test Scheduler
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-secondary" onclick="checkScheduledPosts()">
                        <i class="fas fa-list"></i> Check Scheduled Posts
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary" onclick="debugScheduler()">
                        <i class="fas fa-bug"></i> Debug Scheduler
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success" onclick="testDateTimeComparison()">
                        <i class="fas fa-clock"></i> Test DateTime
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-3">
                    <button class="btn btn-warning" onclick="clearLog()">
                        <i class="fas fa-trash"></i> Clear Log
                    </button>
                </div>
            </div>
            <div id="schedulerResults" class="mt-3"></div>
        </div>
    </div> -->

    <!-- Statistics Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Users</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total FAQs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ faqs|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-question-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Custom Newsletters</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ newsletters|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-envelope fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Scheduled Items</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ newsletters|selectattr('status', 'equalto', 'scheduled')|list|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cron Job URLs Section -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-link"></i> Cron Job URLs
            </h6>
            <small class="text-muted">Use these URLs in your cron jobs to automate publishing and newsletter sending</small>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Blog Publishing -->
                <div class="col-lg-6 mb-3">
                    <div class="card border-left-primary">
                        <div class="card-body">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-blog"></i> Blog Publishing
                            </h6>
                            <p class="card-text small text-muted">Publishes scheduled blogs to WordPress</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="blogCronUrl" 
                                       value="{{ request.host_url.rstrip('/') }}/publish-scheduled-blogs" readonly>
                                <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('blogCronUrl')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <!-- <small class="text-muted">Example: <code>0 */2 * * * curl "URL"</code> (every 2 hours)</small> -->
                        </div>
                    </div>
                </div>

                <!-- Social Posts Publishing -->
                <div class="col-lg-6 mb-3">
                    <div class="card border-left-success">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="fas fa-share-alt"></i> Social Posts Publishing
                            </h6>
                            <p class="card-text small text-muted">Publishes scheduled social posts to LinkedIn/Twitter</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="socialCronUrl" 
                                       value="{{ request.host_url.rstrip('/') }}/publish-scheduled-social-posts" readonly>
                                <button class="btn btn-outline-success" type="button" onclick="copyToClipboard('socialCronUrl')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <!-- <small class="text-muted">Example: <code>0 */2 * * * curl "URL"</code> (every 2 hours)</small> -->
                        </div>
                    </div>
                </div>

                <!-- Newsletter Publishing -->
                <div class="col-lg-6 mb-3">
                    <div class="card border-left-info">
                        <div class="card-body">
                            <h6 class="card-title text-info">
                                <i class="fas fa-envelope"></i> Newsletter Publishing
                            </h6>
                            <p class="card-text small text-muted">Sends scheduled custom newsletters</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newsletterCronUrl" 
                                       value="{{ request.host_url.rstrip('/') }}/publish-scheduled-newsletters" readonly>
                                <button class="btn btn-outline-info" type="button" onclick="copyToClipboard('newsletterCronUrl')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <!-- <small class="text-muted">Example: <code>0 9 * * * curl "URL"</code> (daily at 9 AM)</small> -->
                        </div>
                    </div>
                </div>

                <!-- Monthly WordPress Newsletter -->
                <div class="col-lg-6 mb-3">
                    <div class="card border-left-warning">
                        <div class="card-body">
                            <h6 class="card-title text-warning">
                                <i class="fas fa-calendar-alt"></i> Monthly WordPress Newsletter
                            </h6>
                            <p class="card-text small text-muted">Sends monthly newsletter with WordPress posts</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="monthlyNewsletterCronUrl" 
                                       value="{{ request.host_url.rstrip('/') }}/send-wordpress-newsletter" readonly>
                                <button class="btn btn-outline-warning" type="button" onclick="copyToClipboard('monthlyNewsletterCronUrl')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <!-- <small class="text-muted">Example: <code>0 9 28 * * curl "URL"</code> (28th of each month at 9 AM)</small> -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- All-in-One Scheduler -->
            <!-- <div class="row mt-3">
                <div class="col-12">
                    <div class="card border-left-dark">
                        <div class="card-body">
                            <h6 class="card-title text-dark">
                                <i class="fas fa-cogs"></i> All-in-One Scheduler
                            </h6>
                            <p class="card-text small text-muted">Runs all scheduled tasks (blogs, social posts, newsletters)</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="allSchedulerCronUrl" 
                                       value="{{ request.host_url.rstrip('/') }}/publish-scheduled-blogs && curl {{ request.host_url.rstrip('/') }}/publish-scheduled-social-posts && curl {{ request.host_url.rstrip('/') }}/publish-scheduled-newsletters" readonly>
                                <button class="btn btn-outline-dark" type="button" onclick="copyToClipboard('allSchedulerCronUrl')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <!-- <small class="text-muted">Example: <code>0 */2 * * * curl "URL1" && curl "URL2" && curl "URL3"</code></small> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
    <!-- {% if settings.get('log') %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error Log:</strong><br>
        <pre style="white-space: pre-wrap;">{{ settings.get('log') }}</pre>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %} -->


</div>


{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
// Copy to clipboard function
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        toastr.success('URL copied to clipboard!');
    } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(element.value).then(function() {
            toastr.success('URL copied to clipboard!');
        }).catch(function() {
            toastr.error('Failed to copy URL');
        });
    }
}
function testScheduler() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    
    fetch('/test-scheduler')
        .then(response => response.json())
        .then(data => {
            if (data.type === 'success') {
                toastr.success(data.message);
                setTimeout(() => window.location.reload(), 2000);
            } else {
                toastr.error(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastr.error('An error occurred while testing the scheduler');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function checkScheduledPosts() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    
    fetch('/check-scheduled-posts')
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('schedulerResults');
            if (data.type === 'success') {
                let html = `<div class="alert alert-info">
                    <strong>Current Time:</strong> ${data.current_time}<br>
                    <strong>Total Scheduled Posts:</strong> ${data.total_scheduled}
                </div>`;
                
                if (data.scheduled_posts.length > 0) {
                    html += '<div class="table-responsive"><table class="table table-sm">';
                    html += '<thead><tr><th>ID</th><th>Title</th><th>Scheduled At</th><th>Is Due</th><th>Posted</th><th>Action</th></tr></thead><tbody>';
                    
                    data.scheduled_posts.forEach(post => {
                        const isDueClass = post.is_due ? 'text-danger' : 'text-success';
                        const postedClass = post.posted_to_wordpress ? 'text-success' : 'text-warning';
                        const triggerButton = post.is_due && !post.posted_to_wordpress ? 
                            `<button class="btn btn-sm btn-success" onclick="triggerPost(${post.id})">Trigger Now</button>` : 
                            '<span class="text-muted">-</span>';
                        
                        html += `<tr>
                            <td>${post.id}</td>
                            <td>${post.title}</td>
                            <td>${post.scheduled_at || 'N/A'}</td>
                            <td class="${isDueClass}">${post.is_due ? 'Yes' : 'No'}</td>
                            <td class="${postedClass}">${post.posted_to_wordpress ? 'Yes' : 'No'}</td>
                            <td>${triggerButton}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-warning">No scheduled posts found.</div>';
                }
                
                resultsDiv.innerHTML = html;
            } else {
                toastr.error(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastr.error('An error occurred while checking scheduled posts');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function debugScheduler() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Debugging...';
    
    fetch('/debug-scheduler')
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('schedulerResults');
            if (data.type === 'success') {
                const info = data.debug_info;
                let html = `<div class="alert alert-primary">
                    <h5>🔍 Scheduler Debug Information</h5>
                    <p><strong>Current Time:</strong> ${info.current_time}</p>
                    <p><strong>Total Blogs:</strong> ${info.total_blogs}</p>
                    <p><strong>Scheduled Blogs:</strong> ${info.scheduled_blogs}</p>
                    <p><strong>Due Posts:</strong> ${info.due_posts}</p>
                    <p><strong>Scheduler Status:</strong> <span class="badge bg-success">${info.scheduler_status}</span></p>
                </div>`;
                
                if (info.scheduled_posts_details.length > 0) {
                    html += '<div class="table-responsive"><table class="table table-sm table-bordered">';
                    html += '<thead class="table-dark"><tr><th>ID</th><th>Title</th><th>Scheduled At</th><th>Is Due</th><th>Posted</th><th>Status</th><th>WP Flag</th></tr></thead><tbody>';
                    
                    info.scheduled_posts_details.forEach(post => {
                        const isDueClass = post.is_due ? 'table-danger' : 'table-success';
                        const postedClass = post.posted_to_wordpress ? 'text-success' : 'text-warning';
                        const statusClass = post.status === 'scheduled' ? 'text-primary' : 'text-secondary';
                        
                        html += `<tr class="${isDueClass}">
                            <td>${post.id}</td>
                            <td>${post.title}</td>
                            <td>${post.scheduled_at || 'N/A'}</td>
                            <td>${post.is_due ? '✅ Yes' : '❌ No'}</td>
                            <td class="${postedClass}">${post.posted_to_wordpress ? '✅ Yes' : '❌ No'}</td>
                            <td class="${statusClass}">${post.status}</td>
                            <td>${post.post_to_wordpress ? '✅ Yes' : '❌ No'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="alert alert-warning">No scheduled posts found in debug data.</div>';
                }
                
                resultsDiv.innerHTML = html;
            } else {
                toastr.error(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastr.error('An error occurred while debugging the scheduler');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function triggerPost(blogId) {
    if (confirm(`Are you sure you want to trigger blog ID ${blogId} now?`)) {
        fetch(`/trigger-scheduled-post/${blogId}`)
            .then(response => response.json())
            .then(data => {
                if (data.type === 'success') {
                    toastr.success(data.message);
                    setTimeout(() => checkScheduledPosts(), 1000);
                } else {
                    toastr.error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('An error occurred while triggering the post');
            });
    }
}

function clearLog() {
    if (confirm('Are you sure you want to clear the error log?')) {
        fetch('/admin/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'log='
        }).then(() => {
            toastr.success('Log cleared successfully');
            setTimeout(() => window.location.reload(), 1000);
        }).catch(error => {
            toastr.error('Failed to clear log');
        });
    }
}

function testDateTimeComparison() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    
    fetch('/test-datetime-comparison')
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('schedulerResults');
            if (data.type === 'success') {
                let html = `<div class="alert alert-success">
                    <h5>🕐 DateTime Comparison Test Results</h5>
                    <p><strong>Current Time:</strong> ${data.current_time}</p>
                    <p><strong>Total Scheduled Posts:</strong> ${data.total_scheduled}</p>
                </div>`;
                
                if (data.comparison_results.length > 0) {
                    html += '<div class="table-responsive"><table class="table table-sm table-bordered">';
                    html += '<thead class="table-dark"><tr><th>ID</th><th>Title</th><th>Scheduled At</th><th>Current Time</th><th>Is Due</th><th>Posted</th><th>Status</th></tr></thead><tbody>';
                    
                    data.comparison_results.forEach(result => {
                        const isDueClass = result.is_due ? 'table-danger' : 'table-success';
                        const postedClass = result.posted_to_wordpress ? 'text-success' : 'text-warning';
                        
                        html += `<tr class="${isDueClass}">
                            <td>${result.id}</td>
                            <td>${result.title}</td>
                            <td>${result.scheduled_at || 'N/A'}</td>
                            <td>${result.current_time}</td>
                            <td><strong>${result.is_due ? '✅ YES' : '❌ NO'}</strong></td>
                            <td class="${postedClass}">${result.posted_to_wordpress ? '✅ Yes' : '❌ No'}</td>
                            <td>${result.status}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    
                    // Add summary
                    const duePosts = data.comparison_results.filter(r => r.is_due && !r.posted_to_wordpress);
                    html += `<div class="alert alert-info">
                        <strong>Summary:</strong> ${duePosts.length} posts are due and ready to publish
                    </div>`;
                } else {
                    html += '<div class="alert alert-warning">No scheduled posts found.</div>';
                }
                
                resultsDiv.innerHTML = html;
            } else {
                toastr.error(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastr.error('An error occurred while testing datetime comparison');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}
</script>
{% endblock %}